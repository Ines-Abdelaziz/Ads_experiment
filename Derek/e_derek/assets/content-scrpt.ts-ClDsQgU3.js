let g="N/A";console.log("Content script loaded.");g="factBrowsingHistoryM";function A(n,t,e){const o=document.querySelector("#iframe");o&&k(o,n,e);const r=new MutationObserver(c=>{c.forEach(i=>{if(i.type==="attributes"&&i.target.nodeName==="IFRAME"&&i.target instanceof HTMLIFrameElement){const s=i.target;s.className==t&&(k(s,n,e),r.disconnect())}})});r.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}function k(n,t,e){const o=n.src;o&&o!=="about:blank"&&(C(o,t),e.collected=!0)}function I(n){const t={collected:!1},e=document.querySelector("button.ytp-ad-button-link");console.log(e),e&&(e.addEventListener("click",o=>{setTimeout(()=>{const r=document.querySelector("body ytd-app ytd-popup-container"),c=r.style.display;if(o.screenX===0&&o.screenY===0){console.log("Clicking the ad button"),r&&(r.style.display="none"),setTimeout(()=>{A(n,"style-scope yt-about-this-ad-renderer",t)},4e3);const i=document.querySelector('.ytp-play-button.ytp-button[title*="Play (k)"]');i&&i.click()}else r.style.display=c},3e3)}),setTimeout(()=>{e.click()},3e3),t.collected||e.click())}function E(n){console.log(`Processing ad video ID: ${n} `),I(n)}chrome.runtime.onMessage.addListener((n,t,e)=>{if(n.action==="newAdDetected"){const o=n.adVideoId;console.log("New ad detected:"),console.log("Video ID:",o),E(o)}});async function C(n,t){let e;const o=g;let r=!1,c=!1,i=!1;await P(n,t).then(async s=>{s&&(console.log(s),await j(s).then(async a=>{a&&(a.status===202||a.status===201)&&(a.status===202&&(console.log("Ad already exists in db"),r=!0),a.status===201&&console.log("Ad added to db"),a.json().then(async y=>{console.log(y);var l=b();N(l),M(l).then(async d=>{d&&(console.log(d),e=d.channel_id,await O(e,l).then(async h=>{if(h){console.log(h),console.log(h);const u=await D(h);if(u&&(u.status===202||u.status===201)){u.status===202&&(console.log("Channel already exists in db"),i=!0),u.status===201&&console.log("Channel added to db");const f=await V(d);f&&(f.status===201||f.status===202)&&(f.status===202&&(console.log("Video already exists in db"),c=!0),f.status===201&&console.log("Video added to db"),console.log(s.adlink,l,e,o,s.google_information,s.other_information),s.adlink&&l&&e&&o&&r&&c&&i&&(x(s.adlink,l,e,o,s.google_information,s.other_information),console.log("Ad collected")))}}}))})}))}))})}function P(n,t){return fetch(n).then(e=>e.text()).then(e=>{let o,r,c,i;const s=/<div class="ieH75d-fmcmS">([^<]+)<\/div>/g.exec(e);s?(c=s[1],c=c.replace(/'&%39;/g,"'")):c="N/A";const a=/<div class="ZSvcT-uQPRwe-hSRGPd-haAclf">.*?<a href="(.*?)".*?<\/div>/g.exec(e);a?i=a[1]:i="N/A";const y=/<div class="ieH75d-fmcmS">([^<]+)<\/div>.*?<div class="ieH75d-fmcmS">([^<]+)<\/div>/g.exec(e);y?o=y[2]:o="N/A";const l=/<div class="MDBbYe"[^>]*>(.*?)<\/div>/g.exec(e);l?l[1].includes("&amp;")?r=l[1].split("&amp;"):r=[l[1]]:r=["N/A"];let m,d;const h=/<div class="QVfAMd-wPzPJb-xPjCTc-ibnC6b"[^>]*>(.*?)<\/div>/g,u=e.match(h);u?m=u.map(_=>_.replace(/<\/?[^>]+(>|$)/g,"")):m=["N/A"];const f=/<li class="zpMl8e-C2o4Ve-wPzPJb-xPjCTc-ibnC6b"[^>]*>(.*?)<\/li>/g,v=e.match(f);v?d=v.map(_=>_.replace(/<\/?[^>]+(>|$)/g,"")):d=["N/A"];const w={adlink:t,advertiser:c,advertiser_link:i,advertiser_location:o,topic:r,google_information:m,other_information:d};return console.log(w),w}).catch(e=>(console.error("Error fetching URL:",e),null))}async function M(n){const t=`https://youtubescrapingapi.onrender.com/video_data?video_id=${n}`;try{var e=await(await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}})).json();if(e=e.video_data,e){e.made_for_kids=="N/A"&&(e.made_for_kids=!1),e.view_count=p(e.view_count),e.like_count=p(e.like_count),e.comment_count=p(e.comment_count);const r={video_id:e.video_id,published_at:e.published_at,channel_id:e.channel_id,title:e.title,description:e.description,made_for_kids:e.made_for_kids,view_count:e.view_count,like_count:e.like_count,comment_count:e.comment_count,topic_categories:e.topic_categories};return console.log(r),r}else return console.log("No data found"),null}catch(o){return console.error("Error fetching video details:",o),null}}async function O(n,t){const e=`https://youtubescrapingapi.onrender.com/video_data?video_id=${t}`;try{var o=await(await fetch(e)).json();if(o=o.channel_data,o){o.view_count=p(o.view_count),o.video_count=p(o.video_count);const c={id:o.id,title:o.title,description:o.description,keywords:o.keywords,country:o.country,view_count:o.view_count,video_count:o.video_count,subscriber_count:o.subscriber_count};return console.log(c),c}else return console.log("No data found"),null}catch(r){return console.error("Error fetching channel details:",r),null}}async function V(n){try{const t=await fetch("https://ad-collector.onrender.com/videos",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(t.status!==202&&t.status!==201)throw new Error("Failed to fetch");return t}catch(t){return console.error("Error:",t),null}}async function D(n){try{const t=await fetch("https://ad-collector.onrender.com/channels",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(t.status!==202&&t.status!==201)throw new Error("Failed to fetch");return t}catch(t){return console.error("Error:",t),null}}async function j(n){try{const t=await fetch("https://ad-collector.onrender.com/ad",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(t.status!==202&&t.status!==201)throw new Error("Failed to fetch");return t}catch(t){return console.error("Error:",t),null}}function x(n,t,e,o,r,c){try{fetch("https://ad-collector.onrender.com/user-ad",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ad_id:n,video_id:t,channel_id:e,user_id:o,other_information:c,google_information:r})})}catch(i){console.error("Error:",i)}}function L(n){try{fetch("https://ad-collector.onrender.com/increment-watch-count",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n})})}catch(t){console.error("Error:",t)}}function F(n,t){try{fetch("https://ad-collector.onrender.com/watch-history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:n,video_id:t})})}catch(e){console.error("Error:",e)}}function b(){const t=new URLSearchParams(window.location.search).get("v");return t||null}function N(n){chrome.runtime.sendMessage({action:"updateVideoId",updatedVideoId:n})}function T(){const n=b();N(n)}let S="";const J=new MutationObserver(async n=>{for(const t of n){if(t.type==="attributes"&&t.attributeName==="href"&&window.location.href.includes("youtube.com/watch")&&S!==window.location.href&&(S=window.location.href,await L(g),await F(g,b())),t.type==="attributes"&&t.attributeName==="href"){t.target.href&&T();break}t.type==="childList"&&t.addedNodes.length>0&&t.addedNodes.forEach(e=>{e instanceof HTMLElement&&e.matches("tp-yt-iron-overlay-backdrop")&&e.remove()})}});J.observe(document,{attributes:!0,childList:!0,subtree:!0,attributeFilter:["href"]});T();function p(n){if(n){const t=n.replace(/\D/g,"");return Number(t)}else return 0}
